```{r}
library(aRxiv)
library(openai)
library(stringr)
library(ggplot2)
library(tm)
library(dplyr)
library(httr)
library(jsonlite)
library(psych)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(stargazer)
```

```{r}
Sys.setenv(
  OPENAI_API_KEY = 'your_key_here'
)

df <- read.csv("~/billboard-lyrics-spotify.csv")

# Converting release_date to year and create a new column 'year'
df$year <- as.integer(format(as.Date(df$release_date, "%Y-%m-%d"), "%Y"))

# Calculating the top 5% cutoff for popularity each year and filtering range based on other data set timelines
top_songs <- df %>%
  group_by(year) %>%
  filter(year >= 2001, year <= 2017) %>%
  filter(popularity >= quantile(popularity, 0.95)) %>%
  filter(!is.na(lyrics)) %>%
  arrange(year)
top_songs

# Testing
print(top_songs)

sent_scores <- data.frame(year = integer(), depression_score = numeric(), sad_score = numeric(), stringsAsFactors = FALSE)

for (i in seq_along(top_songs$lyrics)) {
  #print(paste("Processing song:", i))
  lyrics <- top_songs$lyrics[i]
  #print(lyrics)
  #limit 2048 chars
  #if (nchar(lyrics) > 2048) {
    #lyrics <- substr(lyrics, 1, 2048)
  #}
  open_ai_output <- create_chat_completion(
    model = "gpt-3.5-turbo",
    messages = list(
      list(
        "role" = "user",
        "content" = paste0("Consider the following definitions: Depression (also known as major depression, major depressive disorder, or clinical depression) is a common but serious mood disorder. It causes severe symptoms that affect how a person feels, thinks, and handles daily activities, such as sleeping, eating, or working. Sadness describes the range, or family, of emotional states we can experience containing everything from mild disappointment to extreme despair and anguish. Some sad states, starting from least intense to most intense are disappointment, discouragement, distraughtness, resignation, helplessness, misery, despair, grief, sorrow, and anguish.
The text you have been given is lyrics from a song. From a scale of 1 being most depressed/sad to 10 being least depressed/sad, return only two numbers (can be decimal) separated by a comma to represent the depression level and sadness level of the song based on its lyrics. Do not include any lyrics in the return response. For example, a reponse should look like this: 10,3", lyrics)
      )
    )
  )
  #print(open_ai_output$choices$message.content)
  scores <- strsplit(open_ai_output$choices$message.content[1], ",")[[1]]
  depression_score <- as.numeric(scores[1])
  sad_score <- as.numeric(scores[2])
  sent_scores <- rbind(sent_scores, data.frame(year = top_songs$year[i], depression_score = depression_score, sad_score = sad_score))
  Sys.sleep(1)
}


```

MENTAL HEALTH DATA

```{r}
# Mental health dataframe
gallup_data <- data.frame(
  year = c(2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013, 2012, 2011, 2010, 2009, 2008, 2007, 2006, 2005, 2004, 2003, 2002, 2001),
  Excellent = c(29, 28, 28, 29, 31, 29, 29, 31, 32, 32, 30, 30, 32, 31, 28, 28, 32, 32, 34, 29),
  Good = c(50, 53, 51, 47, 48, 50, 49, 49, 49, 49, 51, 48, 48, 50, 51, 50, 48, 50, 45, 49),
  Fair = c(16, 15, 17, 19, 15, 16, 15, 15, 14, 13, 12, 17, 15, 15, 16, 18, 14, 14, 14, 17),
  Poor = c(4, 4, 4, 5, 6, 5, 6, 5, 6, 5, 6, 5, 5, 4, 5, 4, 6, 4, 6, 5),
  No_opinion = c(NA, NA, NA, NA, NA, NA, 1, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 1, NA)
)
gallup_data
```

GRAPHING RESULTS

```{r}
top_songs$Dep_Score <- sent_scores$depression_score
top_songs$Sadness_Score <- sent_scores$sad_score

# Calculating average depression score for each year
avg_dep_scores <- aggregate(Dep_Score ~ year, data = top_songs, FUN = mean)

# Graphing avg depression score for each year
avg_sad_scores <- aggregate(Sadness_Score ~ year, data = top_songs, FUN = mean)

avg_energy_level <- aggregate(energy ~ year, data = top_songs, FUN = mean)

ggplot(avg_dep_scores, aes(x = year, y = Dep_Score)) +
  geom_line() +  # Line connecting the points
  geom_point() +  # The actual data points
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Linear model trend line without confidence band
  scale_x_continuous(breaks = min(avg_dep_scores$year):max(avg_dep_scores$year)) + # Ensure every year is shown
  labs(title = "Depression Sentiment of Songs by Year",
       x = "Year",
       y = "Average Depression Score") +
  theme_minimal()

# Graph avg sad scores
ggplot(avg_sad_scores, aes(x = year, y = Sadness_Score)) +
  geom_line() +  # Line connecting the points
  geom_point() +  # The actual data points
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Linear model trend line without confidence band
  scale_x_continuous(breaks = min(avg_sad_scores$year):max(avg_sad_scores$year)) + # Ensure every year is shown
  labs(title = "Sadness Levels of Songs by Year",
       x = "Year",
       y = "Average Sadness Score") +
  theme_minimal()


```

```{r}

gallup_data <- gallup_data %>%
  filter(year >= 2001, year <= 2017) %>%
  mutate(Total_Responses = Excellent + Good + Fair + Poor,
         Overall_Health_Score = (Excellent * 10 + Good * 7 + Fair * 4 + Poor * 1) / Total_Responses)
gallup_data

top_songs <- left_join(top_songs, gallup_data, by = "year")
top_songs

```

```{r}
top_songs <- top_songs %>%
  filter(year >= 2001, year <= 2017)

# Linear models for each factor
sad_model <- lm(Overall_Health_Score ~ Sadness_Score, data = top_songs)
dep_model <- lm(Overall_Health_Score ~ Dep_Score, data = top_songs)
summary_sad_model <- summary(sad_model)
plot_sad <- ggplot(top_songs, aes(x = Sadness_Score, y = Overall_Health_Score)) + 
  geom_point() +  # This adds the scatter plot points
  geom_smooth(method = "lm", se = TRUE, color = "blue") +  # This adds the regression line
  labs(title = "Relationship between Overall Health and Sadness",
       x = "Sadness Score", y = "Overall Health Score") +
  theme_minimal() 
print(plot_sad)
summary_neg_model <- summary(neg_model)
plot_dep <- ggplot(top_songs, aes(x = Dep_Score, y = Overall_Health_Score)) + 
  geom_point() +  # This adds the scatter plot points
  geom_smooth(method = "lm", se = TRUE, color = "blue") +  # This adds the regression line
  labs(title = "Relationship between Overall Health and Sadness",
       x = "Sadness Score", y = "Overall Health Score") +
  theme_minimal() 
print(plot_dep)

# Correlation scores
correlation_sad <- cor(top_songs$Overall_Health_Score, top_songs$Sadness_Score, use = "complete.obs")
correlation_dep <- cor(top_songs$Overall_Health_Score, top_songs$Dep_Score, use = "complete.obs")
correlation_sad_dep <- cor(top_songs$Sadness_Score, top_songs$Dep_Score, use = "complete.obs")

stargazer(sad_model, type = "text")
stargazer(dep_model, type = "text")
print(correlation_sad)
print(correlation_dep)
bdi_accuracy_comparison <- cocor.dep.groups.overlap(r.jk = correlation_sad, 
                                                    r.jh = correlation_dep, 
                                                    r.kh = correlation_sad_dep, 
                                                    n = 142)
z_bdi_accuracy <- bdi_accuracy_comparison@pearson1898$statistic
p_bdi_accuracy <- bdi_accuracy_comparison@pearson1898$p.value
print(z_bdi_accuracy)
print(p_bdi_accuracy)
```

```         
# Exploring the Relationship Between Popular Music Sentiments and Societal Depression Rates

## Introduction

The intersection of music and mental health has long been a fascination to researchers and the public. The impact of music on people can be significant, as it is a profound reflection of the collective emotional and cultural currents of its time. It can have the power to convey complex emotions and dispositions and perhaps provide a therapeutic outlet.
Historically, music and art have played a significant role in human society, serving not only as a form of entertainment but also as a means of communication, a method of healing, and a catalyst for emotional expression and social change. For example, slave songs in the US repressented both deep sorrow and a yearning for freedom, providing both a psychological outlet and a means of resistance and communication (Levine, 1977).
Understanding this relationship has important implications for public health policies, music therapy, and cultural studies. Depression rates have increased to unprecedented highs especially with the burden of COVID-19 (Goodwin et al., 2022), making deeper analysis and more information regarding this topic to be ever critical. The possibility of music being able to analyze and evaluate mental health conditions is an avenue that must be explored. As famed musician and band leader David Byrne has stated,
"Music tells us things – social things, psychological things, physical things about how we feel and perceive our bodies – in a way that other art forms can't" (Byrne, 2012). By examining popular music on platforms like Spotify, this research focus aims to understand how contemporary society uses music as a reverse outlet for expressing or coping with collective emotions.

## Background

Previous research has explored various aspects of the relationship between music and mental health. For example, studies have shown that music listening can significantly affect mood and can even be used as an intervention in clinical depression (Yinger & Gooding, 2014). Other research has shown that engaging with music and art can reduce stress, alleviate anxiety, improve mood, and even enhance cognitive function (Leubner & Hinterberger, 2017; Stuckey & Nobel, 2010).
However, these established benefits are all concluded from experiments in clinical settings. In other words, these benefits derive out of stuctured, music therapy sessions. 
There remains a substantial gap in literature specifically addressing the predictive relationship between the emotional content of widely consumed, unrestricted, popular music and broader mental health trends. 
While studies have found that adolescents' music dependency increases during periods of depression (McFerran et al., 2014), the extrapolation of these findings to a larger-scale in terms of the general population and music's influence on overall mental health is less understood.
Moreover, the rise of digital media has transformed access to music and art, with vast libraries of songs, artworks, and performances available at the fingertips of users worldwide. Platforms like Spotify, YouTube, and various art-sharing websites not only provide access but also allow insights into consumer preferences and trends through data analytics. Preliminary studies suggest that patterns in music and art consumption may reflect wider societal mental health states, with changes in genre popularity correlating with economic, social, and political changes (Rentfrow et al., 2011; Liu et al., 2018). In regards to Spotify specifically, studies have been able to find correlations between listening behavior and music and users' personality traits (Anderson et al., 2020).
However, there exists a notable lack of research linking the emotional content of songs with longitudinal mental health outcomes in the general population. Such studies could potentially reveal predictive relationships that could be used for early identification of mental health trends, enabling better-targeted interventions and policies. As online platform usage for music and art engagement continuously rises, patterns in these activities could serve as early indicators of mental health shifts across different demographics. 
The increase in mental health issues globally, as indicated by the World Health Organization, further underscores the need for innovative research approaches that incorporate these ubiquitous cultural artifacts (WHO, 2017).

 
While the connection between art, music, and wellness is recognized in therapeutic settings, the body of research behind how emotional content of popular music correlates with societal mental health trends is sparse. This gap presents an opportunity for a novel inquiry into how everyday music and art interactions could serve as a barometer for societal mental health states, thus guiding future public health strategies and interventions. This report seeks to help address this gap by exploring whether there is any relationship between the negative emotional/sadness sentiments expressed in popular songs on Spotify and societal depression rates from 2001 to 2017.  


### Hypotheses

- **Hypothesis 1:** There is a statistically significant relationship between sadness scores of most popular songs and overall health scores, where increases in sadness scores are associated with decreases in overall health scores.

- **Hypothesis 2:** There is a statistically significant relationship between depression sentiment level of most popular songs and overall health scores, where increases in depression scores are associated with decreases in overall health scores.

- **Hypothesis 3:** The correlation between the sadness levels in top songs and overall mental health is not significantly different from the correlation between depression sentiment levels in top songs and overall mental health.

## Methodology

### Experiment Setup

The data on mental wellbeing rates was taken from Gallup, who carries out an annual survey of self-reported mental health levels for Americans (Brenan, 2024). The survey provides 5 options for people to choose from when characterizing their mental health that year: excellent, good, only fair, poor, and no opinion. This dataset was chosen due to its continuity throughout the years; data from other organizations such as the CDC or NHI either had gaps in the data (years where data was missing or inconsistency with data measurement between years) or did not collect mental health information in earlier years.
The study focused on the years 2001 to 2017, as the Gallup study dates back to 2001 and the popular songs data is limited to 2017. The dataset for the top songs was retrieved from GitHub, where a user utilized Spotify's API to collect all the top songs from each year and combine it with song lyric websites to create a concluding data table aligning together each top song with its lyrics (Zhao). This dataset's inclusion of lyrics was unique; many other datasets had the most popular songs as well but none of the lyrics of said songs.
The songs' lyrics were analyzed using the OpenAI API to evaluate emotional content levels. Two slightly different prompts were fed to the OpenAI mechanism, one asking the system to determine the depression sentiment level of the song lyrics and the other asking it to determine the sadness level of the song lyrics. The machine was asked to determine both of these levels on a sliding scale from 1 to 10, with 1 being the most sad/depressed and 10 being the least sad/depressed. To ensure OpenAI's accuracy, a definition for both depression and sadness was provided at the beginning of the prompt. The definition were selected from expert sources to maintain accuracy; the definition of depression was taken from the National Intitute of Mental Health and the definition of sadness is from Paul Eckman's, a esteemed leader in emotions and psychology.
Due to the fact that the Gallup data was based on an annual survey, the average of the sadness/depressed levels of songs in the same year were calculated and then put into a dataframe with the year corresponding with the numerical sadness/depressed sentiment.
To standardize the reported mental health levels with the sadness/depressed levels of the song lyrics, the mental health data was also implemented on a sliding scale from 1 to 10. "No opinion" selections were not considered in the mental health data conversions because for each year, there was at most 1 "no opinion" response. A uniform scale with equal distance between the 4 selections was implemented; "poor" is labeled as 1, "only fair" is 4, "good" is 7, and "excellent" is 10. To calculate the mental health score for a specific year, we calculated the weighted average based on the labeled weights from 1 to 10.
2 graphs, one for sadness and the other for depression, were produced, displaying average sadness and depression sentiment for each year. There is also a general linear trend line in each to show overall change in sentiment levels over the 16 years. 
Statistical methods were employed to analyze the correlation between the average yearly sentiment scores of popular songs and the depression rates in society. 2 linear regression models were created, one for analyzing the relationship between sadness sentiment of the songs and reported mental health levels and the other for analyzing the relationship between depression sentiment of the songs and reported mental health levels. Additionally, a William's test was conducted to compare the two correlations. The William's test was chosen over the Steiger's test to test correlation differences because the two correlations I intend to compare have one overlapping variable (mental health scores), which is thus more appropriately suited for William's over Steiger's.

## Results
The correlation coefficient for sadness sentiment of top songs and overall mental health is approximately 0.204, suggesting that top songs' sadness levels decrease while overall health scores increases, which is opposite of the hypothesis's prediction. However, the correlation coefficient is close to 0, meaning the strength of the correlation between the sadness levels of songs and mental health scores is weak.
The p-value is 0.716, meaning the relationship between the 2 are not statistically significant since the p-value is greater than 0.05. The data does not prove nore disprove Hypothesis 1.

The correlation coefficient for negative sentiment of top songs and overall mental health is approximately -0.050, indicating that as songs' depression levels increase, overall mental health scores increase. This is in the same direction of Hypothesis 2. However,the correlation coefficient is very close to 0, meaning the correlation strength is extremely weak.
Additionally, the p-value for is 0.852, meaning the relationship between the 2 are not statistically significant. Thus, Hypothesis 2 cannot be proven nor disproven by the data.

Only about 4.17% of the variability in mental health ratings is explained by sadness score changes and about 0.24% of mental health variability can be explained by depression score changes, meaning the two models are quite weak and not suitable in predicting mental health. The very low R-squared values of both models show that sadness and depression scores of popular songs are not good predictors for mental health levels; instead, there are other factors out there that better predict and significantly influence mental health levels.

Hypothesis 3: Comparison of Correlations
Coefficient Comparison: Both coefficients (for Sadness_Score and Depression_Score) are small and not statistically significant. The coefficient for sadness is slightly larger, but neither is significant.
I utilized the Fisher-Z's transformation test to compare the correlation between sadness levels and overall mental health and between depression levels and overall mental health, and the results are as followed:
Z-value: -0.369
The Z-value is relatively small, meaning that the observed difference between the two correlations is slight or negligible.
The p-value of 0.712 is much higher than 0.05, meaning that these correlations are not significantly different from each other.
Given that both individual correlations are not statistically significant and they are not significatnyl different from each other, Hypothesis 3 cannot be rejected nor accepted based on the results.

## Existing Research and Significance

This study is particularly significant given the increasing rates of depression and the corresponding need for effective public health strategies. By identifying patterns in music consumption and emotional expression, policymakers and health professionals can better understand the public's mental state and potentially leverage music as a form of early intervention or public health messaging.

This research aims to bridge the gap between cultural expressions of emotion through music and empirical mental health trends. By understanding how society collectively expresses its emotional state through the arts, we can gain insights into the underlying psychological and social dynamics influencing mental health on a large scale. This can ultimately lead to more informed and effective interventions that address the emotional needs of the population.

## LIMITATIONS
This experiment has some key limitations to consider. 
First, the sample size was only 142 songs, meaning the size may be too small to effectively detect if a relationship exists. Any patterns are also unable to be generalized to a broader population or context due to the small sample.
Additionally, the data itself had its drawbacks. The Gallup data only started in 2001 and the Spotify data ended at 2017. It would be beneficial to carry out this experiment on data over a longer period of time and with more recent data. In particular, data from 2019-2020 would be intriguing due to the onset of COVID-19. As mental health becomes more of an acknowledged topic, more recent data would be more extensively and comprehensively sourced and measured, thus making the data more useful and favorable to the study.
There are also some discrepancies within the data used. The Gallup poll data for mental health is all self-reported, meaning the credibility of the responses is questionable since individuals are not experts in mental health. It was also a survey, so only those who wanted to respond responded, causing non-response bias which makes the results unrepresentative of the entire population. This has the tendency to create extreme results since usually people who have extreme opinions on the survey topic are more likely to respond.
The Spotify data was extensive and OpenAI was unable to run through all of the data in time, causing me to only use the top 5% most popular songs in each year. This can cause inaccuracies in the sense that popular songs within each year were not well-represented as not all songs were tested. It is possible that going through all of the songs in the dataset may produce more accurate results. The results of the research also only apply to Spotify users, which is not necessarily the entire US population. This means the subject demographic is skewed towards, younger, tech-savvy people. I chose Spotify because it is the leading platform for music (Steele & Journal, 2024) but there are other platforms such as Apple Music and Pandora that people use.
OpenAI itself can also be unreliable. Artificial intelligence machines are still developing and are thus prone to mistakes. OpenAI's evaluation of the depression and sadness levels of the song lyrics may be inaccurate, as it requires precise training and model specifications to produce beneficial results (Burtsev et al., 2023)
Only 2 factors, depression and sadness levels of songs, were considered in this study. In the future, experimentation and analysis of other factors, such as human demographics, environment, etc, must be considered as there are other confounding variables in this current study that may play a more significant role in predicting mental health levels.



## SOURCES
Aalbers, S., Fusar-Poli, L., Freeman, R., Spreen, M., Ket, H., Vink, A. C., Maratos, A., Crawford, M., Chen, X. J., & Gold, C. (2017). Music therapy for depression. Cochrane Library, 2017(11). https://doi.org/10.1002/14651858.cd004517.pub3
Anderson, I., Gil, S., Gibson, C., Wolf, S. T., Shapiro, W., Semerci, O., & Greenberg, D. M. (2020). “Just The Way You Are”: linking music listening on Spotify and personality. Social Psychological & Personality Science, 12(4), 561–572. https://doi.org/10.1177/1948550620923228
Brenan, B. M. (2024, February 28). Americans’ mental health ratings sink to new low. Gallup.com. https://news.gallup.com/poll/327311/americans-mental-health-ratings-sink-new-low.aspx
Burtsev, M., Reeves, M., & Job, A. (2023, November). The working limitations of large language models. MIT Sloan Management Review. Retrieved April 27, 2024, from https://sloanreview.mit.edu/article/the-working-limitations-of-large-language-models/
Byrne, D. (2012). How music works. http://ci.nii.ac.jp/ncid/BB11221374
Depression. (n.d.). National Institute of Mental Health (NIMH). https://www.nimh.nih.gov/health/topics/depression
Levine, L. W. (1993). Slave Songs and Slave Consciousness: Explorations in Neglected sources. In Oxford University Press eBooks (pp. 35–58).
https://doi.org/10.1093/acprof:oso/9780195082975.003.0003
Leubner, D., & Hinterberger, T. (2017). Reviewing the effectiveness of music interventions in treating Depression. Frontiers in Psychology, 8. https://doi.org/10.3389/fpsyg.2017.01109
Liu, M., Hu, X., & Schedl, M. (2018). The relation of culture, socio-economics, and friendship to music preferences: A large-scale, cross-country study. PloS one, 13(12), e0208186. https://doi.org/10.1371/journal.pone.0208186
Rentfrow, P. J., Goldberg, L. R., & Levitin, D. J. (2011). The structure of musical preferences: a five-factor model. Journal of personality and social psychology, 100(6), 1139–1157. https://doi.org/10.1037/a0022406
Steele, A., & Journal, P. C. F. W. S. (2024, January 18). Spotify dominates audio streaming, but where are the profits? WSJ. https://www.wsj.com/business/media/spotify-streaming-music-podcasts-audiobooks-3e88180d
Stuckey, H. L., & Nobel, J. (2010). The connection between art, healing, and public health: A review of current literature. American Journal of Public Health, 100(2), 254–263. https://doi.org/10.2105/AJPH.2008.156497
Yinger, O. S., & Gooding, L. (2014). Music therapy and music medicine for children and adolescents. Child and adolescent psychiatric clinics of North America, 23(3), 535–553. https://doi.org/10.1016/j.chc.2013.03.003
What is Sadness? | Feeling Sadness | Paul Ekman Group. (2022, November 4). Paul Ekman Group. https://www.paulekman.com/universal-emotions/what-is-sadness/
Zhao. (n.d.). spotify-song-lyric-analysis/readme.html at master · zhao1701/spotify-song-lyric-analysis. GitHub. https://github.com/zhao1701/spotify-song-lyric-analysis/blob/master/readme.html
```
